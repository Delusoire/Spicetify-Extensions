import{array as k,string as it,function as Q}from"https://esm.sh/fp-ts";import{array as I,eq as V,string as W,record as ot,semigroup as lt,function as S}from"https://esm.sh/fp-ts";import{guard as q,memoize as z}from"https://esm.sh/fp-ts-std/Function";var L=e=>q(e);var c=e=>async t=>e(await t),U=e=>t=>i=>i[e]===t;var A=e=>t=>S.flow(I.chunksOf(e),I.map(t),i=>Promise.all(i),c(I.flatten));var E=e=>S.pipe(e,S.tupled,z(V.contramap(JSON.stringify)(W.Eq)),S.untupled);import{array as dt,function as B}from"https://esm.sh/fp-ts";var gt={before:{start:B.constant({before:"start"}),fromUri:e=>({before:{uri:e}}),fromUid:e=>({before:{uid:e}})},after:{end:B.constant({after:"end"}),fromUri:e=>({after:{uri:e}}),fromUid:e=>({after:{uid:e}})}},C=e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),y=e=>e.replace(/\b\w/g,t=>t.toUpperCase());var h=(e,t=1e3,i=document.body,s)=>new Promise(r=>{let n=l=>{p.disconnect(),r(l)},p=new MutationObserver(()=>{let l=document.querySelector(e);if(l&&(!s||l!==s))return n(l)});p.observe(i,{childList:!0,subtree:!0}),t&&setTimeout(()=>n(null),t)});var b=e=>new Promise(t=>setTimeout(t,e));var D=async e=>(await Spicetify.GraphQL.Request(Spicetify.GraphQL.Definitions.queryArtistRelated,{uri:e,locale:Spicetify.Locale.getLocale()})).data.artistUnion.relatedContent.relatedArtists.items;var O=A(50)(async e=>(await Spicetify.CosmosAsync.get(`https://api.spotify.com/v1/artists?ids=${e.join(",")}`)).artists),xt=A(1)(async([e])=>[await Spicetify.CosmosAsync.get(`https://api.spotify.com/v1/playlists/${e}`)]),Pt=A(50)(async e=>(await Spicetify.CosmosAsync.get(`https://api.spotify.com/v1/albums?ids=${e.join(",")}`)).albums),It=A(50)(async e=>(await Spicetify.CosmosAsync.get(`https://api.spotify.com/v1/tracks?ids=${e.join(",")}`)).tracks),K=async(e,t)=>Spicetify.CosmosAsync.get(`https://api.spotify.com/v1/search?q=${encodeURIComponent(e)}&type=${t.join(",")}`),d=async e=>{let t=`The Sound Of ${e}`,i=new RegExp(`^${C(t)}$`,"i"),r=(await K(t,["playlist"])).playlists.items[0];return r?.owner.id==="thesoundsofspotify"&&i.test(r.name)?r.uri:null};var R=async(e,t,i,s="")=>{let r=new URL("https://ws.audioscrobbler.com/2.0/");return r.searchParams.append("method","track.getInfo"),r.searchParams.append("api_key",e),r.searchParams.append("artist",t),r.searchParams.append("track",i),r.searchParams.append("format","json"),r.searchParams.append("username",s),await fetch(r).then(n=>n.json())},Rt=E(R);import{array as u,string as N,function as v}from"https://esm.sh/fp-ts";import{prepend as J}from"https://esm.sh/fp-ts-std/String";var{URI:F}=Spicetify,w=async({pathname:e})=>{let t=F.fromString(e);if(!F.isArtist(t))return;let i=document.createElement("div");i.className="main-entityHeader-detailsText genre-container",i.innerHTML=await v.pipe(await T([`${t}`]),u.takeLeft(5),u.map(async r=>{let n=await d(r);return`<a class="main-entityHeader-genreLink" ${n===null?`href="#" data-value="${r}" onclick="searchPlaylist(this.getAttribute('data-value'))`:`href="${n}"`} style="color: var(--spice-subtext); font-size: 1rem">${y(r)}</a>`}),r=>Promise.all(r),c(u.intercalate(N.Monoid)("<span>, </span>")),c(J("<span>Artist Genres : </span>"))),document.querySelector(".genre-container")?.remove(),(await h("div.main-entityHeader-headerText"))?.insertBefore(i,await h("span.main-entityHeader-detailsText"))},T=async(e,t=null)=>{let i=v.flow(u.map(r=>F.fromString(r).id),O,c(u.flatMap(r=>r.genres)),c(u.uniq(N.Eq))),s=await i(e);return s.length?s:await v.pipe(e[0],D,c(u.map(r=>r.uri)),c(u.chunksOf(5)),c(u.reduce(Promise.resolve([]),async(r,n)=>(await r).length?await r:await i(n))))};import{task as X}from"https://esm.sh/fp-ts";var{React:o}=Spicetify,M=globalThis.genrePopup=()=>{Spicetify.PopupModal.display({title:`Genres of: ${Spicetify.Player.data.track?.metadata?.title}`,content:o.createElement("div",{className:"genres-popup"},m.length===0?o.createElement(o.Fragment,null):o.createElement(Y,null),g.length===0?o.createElement(o.Fragment,null):o.createElement(Z,null)),isLarge:!0})},G=({name:e="",color:t="",onClick:i=X.of(void 0)})=>o.createElement("button",{className:`login-button${t}`,onClick:i},e),Y=()=>{let[e,t]=o.useState(m);Spicetify.Player.addEventListener("songchange",()=>setTimeout(()=>t(m),500));let i=s=>async()=>{let r=await d(s);r===null?Spicetify.Platform.History.push(`/search/${s}/playlists`):Spicetify.Platform.History.push(`/playlist/${r.split(":")[2]}`),Spicetify.PopupModal.hide()};return o.createElement("div",{className:"spaced-down"},o.createElement("h1",{className:"title"},"Spotify Genres"),e.map(s=>o.createElement(G,{name:y(s),onClick:i(s)})))},Z=()=>{if(g.length==0)return o.createElement(o.Fragment,null);let[e,t]=o.useState(g);Spicetify.Player.addEventListener("songchange",()=>setTimeout(()=>t(g),100));let i=s=>async()=>{Spicetify.Platform.History.push(`/search/${s}/playlists`),Spicetify.PopupModal.hide()};return o.createElement("div",{className:"spaced-down"},o.createElement("h1",{className:"title"},"Last FM Tags"),e.map(s=>o.createElement(G,{name:y(s),onClick:i(s)})))};import{task as et}from"https://esm.sh/fp-ts";import{task as H}from"https://esm.sh/fp-ts";import{constVoid as x}from"https://esm.sh/fp-ts/function";var{React:a,ReactDOM:tt}=Spicetify,P=class e{constructor(t,i,s={}){this.name=t;this.sectionId=i;this.sectionFields=s}stopHistoryListener;setRerender=null;static waitForReact=async()=>{for(;!(Spicetify.React&&Spicetify.ReactDOM);)b(100);return this};pushSettings=async()=>{for(;!Spicetify?.Platform?.History?.listen;)await b(100);this.stopHistoryListener&&this.stopHistoryListener(),this.stopHistoryListener=Spicetify.Platform.History.listen(({pathname:t=""})=>{t==="/preferences"&&this.render()}),Spicetify.Platform.History.location.pathname==="/preferences"&&await this.render()};toObject=()=>new Proxy({},{get:(t,i)=>e.getFieldValue(this.getId(i.toString()))});rerender=()=>{this.setRerender&&this.setRerender(Math.random())};render=async()=>{for(;!document.getElementById("desktop.settings.selectLanguage");){if(Spicetify.Platform.History.location.pathname!=="/preferences")return;await b(100)}let t=document.querySelector(".x-settings-container"),i=Array.from(t.children).find(({id:s})=>s===this.sectionId);i||(i=document.createElement("div"),i.id=this.sectionId,i.className="settingsContainer",t.appendChild(i)),tt.render(a.createElement(this.FieldsContainer,null),i)};addButton=(t,i,s,r=x,n={})=>{let p=this.getId(t);return n.onClick=r,this.sectionFields[t]={id:p,type:"button",description:i,text:s,events:n},this};addToggle=(t,i,s=H.of(!0),r=x,n={})=>{let p=this.getId(t);return e.setDefaultFieldValue(p,s),n.onChange=r,this.sectionFields[t]={id:p,type:"toggle",description:i,events:n},this};addInput=(t,i,s,r=x,n="text",p={})=>{let l=this.getId(t);return e.setDefaultFieldValue(l,s),p.onChange=r,this.sectionFields[t]={id:l,type:"input",description:i,inputType:n,events:p},this};addDropDown=(t,i,s,r=H.of(0),n=x,p={})=>{let l=this.getId(t);return e.setDefaultFieldValue(l,r),p.onChange=n,this.sectionFields[t]={id:l,type:"dropdown",description:i,options:s,events:p},this};addHidden=(t,i)=>{let s=this.getId(t);return e.setDefaultFieldValue(s,i),this.sectionFields[t]={id:s,type:"hidden",description:""},this};getId=t=>`extensions:${this.sectionId}:${t}`;useStateFor=t=>{let[i,s]=a.useState(e.getFieldValue(t));return[i,r=>{r!==void 0&&(s(r),e.setFieldValue(t,r))}]};static getFieldValue=t=>JSON.parse(Spicetify.LocalStorage.get(t)??"null");static setFieldValue=(t,i)=>{Spicetify.LocalStorage.set(t,JSON.stringify(i))};static setDefaultFieldValue=async(t,i)=>{e.getFieldValue(t)===null&&e.setFieldValue(t,await i())};FieldsContainer=()=>{let[t,i]=a.useState(0);return this.setRerender=i,a.createElement("div",{className:"x-settings-section",key:t},a.createElement("h2",{className:"Type__TypeElement-sc-goli3j-0 TypeElement-cello-textBase-type"},this.name),Object.entries(this.sectionFields).map(([s,r])=>a.createElement(this.Field,{field:r})))};Field=({field:t})=>{let i=U("type");return a.createElement("div",{className:"x-settings-row"},a.createElement(this.SettingDescription,{id:t.id,description:t.description}),a.createElement("div",{className:"x-settings-secondColumn"},L([[i("input"),this.SettingInputField],[i("button"),this.SettingButtonField],[i("toggle"),this.SettingToggleField],[i("dropdown"),this.SettingDropdownField]])(this.SettingHidden)(t)))};SettingDescription=({id:t,description:i})=>a.createElement("div",{className:"x-settings-firstColumn"},a.createElement("label",{className:"Type__TypeElement-sc-goli3j-0 TypeElement-viola-textSubdued-type",htmlFor:t},i));SettingButtonField=t=>a.createElement("span",{className:""},a.createElement("button",{id:t.id,className:"Button-sc-y0gtbx-0 Button-sm-buttonSecondary-useBrowserDefaultFocusStyle x-settings-button",...t.events,type:t.type},t.text));SettingToggleField=t=>{let[i,s]=this.useStateFor(t.id);return a.createElement("label",{className:"x-settings-secondColumn x-toggle-wrapper"},a.createElement("input",{id:t.id,className:"x-toggle-input",type:"checkbox",checked:e.getFieldValue(t.id),...t.events,onChange:r=>{s(r.currentTarget.checked),t.events.onChange?.(r)}}),a.createElement("span",{className:"x-toggle-indicatorWrapper"},a.createElement("span",{className:"x-toggle-indicator"})))};SettingInputField=t=>{let[i,s]=this.useStateFor(t.id);return a.createElement("input",{className:"x-settings-input",id:t.id,dir:"ltr",value:e.getFieldValue(t.id),type:t.inputType,...t.events,onChange:r=>{s(r.currentTarget.value),t.events.onChange?.(r)}})};SettingDropdownField=t=>{let[i,s]=this.useStateFor(t.id);return a.createElement("select",{className:"main-dropDown-dropDown",id:t.id,...t.events,onChange:r=>{s(r.currentTarget.selectedIndex),t.events.onChange?.(r)}},t.options.map((r,n)=>a.createElement("option",{selected:n===e.getFieldValue(t.id),value:n+1},r)))};SettingHidden=()=>a.createElement(a.Fragment,null)};var _=new P("Show The Genres","show-the-genres").addInput("LFMApiKey","Last.fm API Key",et.of("44654ea047786d90338c17331a5f5d95"));_.pushSettings();var $=_.toObject();var ie=globalThis.searchPlaylist=e=>Spicetify.Platform.History.push(`/search/${e}/playlists`),m=new Array,g=new Array,rt=async e=>(f.innerHTML=await Q.pipe(e,k.map(async t=>`<a href="${await d(t)??"#"}" style="color: var(--spice-subtext); font-size: 12px">${y(t)}</a>`),t=>Promise.all(t),c(k.intercalate(it.Monoid)("<span>, </span>"))),f),st=async e=>{let t=await h("div.main-trackInfo-container"),{uri:i,metadata:s}=Spicetify.Player.data.track;s&&Spicetify.URI.isTrack(i)&&e.length?(t?.appendChild(await rt(e)),g=Q.pipe(await R($.LFMApiKey,s.artist_name,s.title),({track:r})=>r.toptags.tag,k.map(({name:r})=>r))):t?.removeChild(f)},nt=()=>{let e=Spicetify.Player.data?.item.metadata??{};return[...Array(10).keys()].map(t=>e["artist_uri"+(t?`:${t}`:"")]).filter(Boolean)},j=async()=>{let e=nt();m=await T(e),await st(m.slice(0,5))},f=document.createElement("div");f.className="main-trackInfo-genres ellipsis-one-line main-type-finale";f.style.gridArea="genres";f.addEventListener("contextmenu",M);Spicetify.Player.addEventListener("songchange",j);j();Spicetify.Platform.History.listen(w);w(Spicetify.Platform.History.location);export{g as lastFmTags,m as spotifyGenres};
//! Does location actually point to document.body?
(async () => {
    if (!document.getElementById("show-the-genres-css")) {
        const el = document.createElement("style")
        el.id = "show-the-genres-css"
        
        el.textContent = String.raw`".genres-popup:after{content:\"\";display:table;clear:both}.genres-popup .title{color:var(--spice-text)}.genres-popup .spaced-down{margin-bottom:20px}.genres-popup .login-button{background-color:var(--spice-button);border-radius:8px;border-style:none;color:var(--spice-text);cursor:pointer;font-size:14px;height:40px;margin:10px;padding:5px 10px;text-align:center}.genres-popup .login-button:hover{background-color:var(--spice-button-active)}.main-nowPlayingWidget-trackInfo.main-trackInfo-container{grid-template:\"title title\" \"badges subtitle\" \"genres genres\"/auto 1fr auto}\n"`
        document.head.appendChild(el)
    }
})